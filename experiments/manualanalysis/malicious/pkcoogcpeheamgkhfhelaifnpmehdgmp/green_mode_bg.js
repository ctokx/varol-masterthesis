const e=new Map;let t=null;function o(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch(t){return console.error("Invalid URL:",e,t),""}}async function n(){const t=await fetch("partners.json");return(await t.json()).forEach((t=>{const n=o(t.partner_url);n&&e.set(n,{affiliate_url:t.affiliate_url})})),e}function r(e,t){return Date.now()-e>=60*t*1e3}async function a(t){if(!(t&&e.has(t)))return!1;const o=(await chrome.storage.local.get(t))[t];if(!o)return!0;return r(o,60)}async function s(e){return(await chrome.storage.local.get("tempTabId")).tempTabId!==e}function c(){t&&chrome.tabs.onUpdated.removeListener(t),t=async(t,n,r)=>{if(await s(t)&&"complete"===n.status){const n=o(r.url);if(await a(n)){const o=e.get(n);o&&o.affiliate_url&&(i(o.affiliate_url,n),l(t))}}},chrome.tabs.onUpdated.addListener(t)}function i(e,t){chrome.storage.local.set({[t]:Date.now()});chrome.tabs.create({url:e,active:!1},(e=>{chrome.storage.local.set({tempTabId:e.id},(()=>{chrome.tabs.onUpdated.addListener((function t(o,n){o===e.id&&"complete"===n.status&&setTimeout((()=>{chrome.tabs.get(o,(()=>{chrome.tabs.onUpdated.removeListener(t),chrome.storage.local.remove("tempTabId"),chrome.runtime.lastError||chrome.tabs.remove(o)}))}),2e3)}))}))}))}function l(e){function t(e){const t=document.createElement("div"),o=t.attachShadow({mode:"open"}),n=document.createElement("style");n.textContent=e;const r=document.createElement("div");r.innerHTML=`<div class="overlay" style="background-color: unset;">\n                                <div class="popup">\n                                    <div class="side-by-side">\n                                        <h1 style="color: #000;">${chrome.i18n.getMessage("tab_opened_popup_title")} - ${chrome.i18n.getMessage("ext_name_generic")}</h1>\n                                    </div>\n                                    <p>${chrome.i18n.getMessage("tab_opened_popup_subtitle")}</p>\n                                    <p>${chrome.i18n.getMessage("tab_opened_popup_subtitle1")}</p>\n                                    <p>${chrome.i18n.getMessage("tab_opened_popup_paragraph1")}</p>\n                                    <p>${chrome.i18n.getMessage("tab_opened_popup_paragraph2")}</p>\n                                    <p>${chrome.i18n.getMessage("tab_opened_popup_paragraph3")}</p>\n                                    <a href="https://scripts.green/more-about-green-mode/" target="_blank">${chrome.i18n.getMessage("request_perms_popup_learn_more")}</a>\n                                    <div class="buttons">\n                                        <button type="button" id="close_button" class="allow">${chrome.i18n.getMessage("tab_opened_popup_close_button")}</button>\n                                        <button type="button" id="close_forever_button" class="deny">${chrome.i18n.getMessage("tab_opened_popup_close_forever_button")}</button>\n                                    </div>\n                                </div>\n                            </div>`,o.appendChild(n),o.appendChild(r),document.body.appendChild(t),o.getElementById("close_button").addEventListener("click",(()=>{document.body.removeChild(t)})),o.getElementById("close_forever_button").addEventListener("click",(()=>{document.body.removeChild(t)}))}chrome.storage.local.get("hasUserBeenNotifiedAboutTabOpened",(async o=>{if(o.hasUserBeenNotifiedAboutTabOpened)return;const n=await fetch(chrome.runtime.getURL("/styles/style.css")),r=await n.text();chrome.scripting.executeScript({target:{tabId:e},func:t,args:[r]}).then((()=>{chrome.storage.local.set({hasUserBeenNotifiedAboutTabOpened:!0})}))}))}async function d(){try{await u()&&(console.log("%cðŸŒ± Green Mode Activated! ðŸŒ±","background: green; color: white;"),await n(),c())}catch(e){console.error("Error checking permissions:",e)}}function p(){console.log("%câ›” Green Mode Deactivated! â›”","background: red; color: white;"),t&&(chrome.tabs.onUpdated.removeListener(t),t=null)}function u(){return new Promise(((e,t)=>{chrome.storage.local.get("hasUserAllowedGreenMode",(o=>{chrome.runtime.lastError?t("Error while checking if green mode is allowed: "+chrome.runtime.lastError):void 0===o.hasUserAllowedGreenMode?e(null):"boolean"==typeof o.hasUserAllowedGreenMode?e(o.hasUserAllowedGreenMode):t(new Error("Unexpected value type in storage."))}))}))}chrome.runtime.onInstalled.addListener((async e=>{"install"===e.reason&&chrome.tabs.create({url:chrome.runtime.getURL("activate_green_mode.html")})})),chrome.runtime.onMessage.addListener((function(e,t,o){return"checkIfUserHasAllowedGreenMode"===e.permAction?(u().then((e=>{o({permStatus:e})})).catch((e=>{console.error(e),o({permStatus:!1})})),!0):"allowGreenMode"===e.permAction?(chrome.storage.local.set({hasUserAllowedGreenMode:!0},(()=>{chrome.runtime.lastError&&(p(),o({granted:!1})),d(),o({granted:!0})})),!0):"declineGreenMode"===e.permAction?(chrome.storage.local.set({hasUserAllowedGreenMode:!1},(()=>{p(),o({granted:!1})})),!0):void 0})),d();